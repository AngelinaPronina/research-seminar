---
title: "Визуализация временных рядов при помощи пакета dygraphs"
author: "Аркадий Пригожин, Заходякин Г.В."
output: 
  html_document: 
    number_sections: no
    toc: yes
    toc_float: yes
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Введение

`dygraphs` - мощный и современный пакет для визуализации данных временных рядов в R.
Важное преимущество dygraphs перед ggplot в том, что пакет создает интерактивные графики, которые можно встроить как в документы R Markdown (такой, как этот), и в веб-приложения.


# Установка пакета

Если вы используете дистрибутив R, подготовленный для курса, то пакет `dygraphs` у вас уже есть.

Если вы устанавливали R самостоятельно, то пакет нужно установить (раскомментируйте и запустите команду):

```{r Установка dygraphs}
#install.packages("dygraphs")
```

После этого, вы сможете подключить этот и другие необходимые пакеты обычным образом:

```{r Подключение пакетов, message=FALSE, warning=FALSE}
library(dygraphs) # интерактивная визуализация временных рядов
library(forecast) # прогнозирование
library(sophisthse) # загрузка данных из ЕАЭСД вышки
library(lubridate) # гладкая работа с датами
```


# Базовые примеры

Теперь, когда у вас установлен и подключен пакет dygraphs, можно приступить к визуализации.

В качестве примера возьмем данные из Единого архива социально-экономических данных НИУ ВШЭ. 
Мы будем работать с двумя показателями - `RTRD_M` и `RTRD_M_DIRI`.

```{r Получение данных}
df <- sophisthse('RTRD_M') %>% 
  window(start = c(1995, 1))
time_series1 <- df[, 'RTRD_M']
time_series2 <- df[, 'RTRD_M_DIRI']
```

## Hello, world!

Самый простой пример визуализации будет выглядеть следующим образом:

```{r Визуализация временного ряда}
dygraph(time_series1)
```

Вы можете заметить, что в отличии от графиков `ggplot`, графики `dygraphs` интерактивны - наведя на график курсор мыши, можно посмотреть, какое значение имеет каждая точка в определенный момент времени. 

Обратите внимание, что если выделить мышкой определенный участок по горизонтали или по вертикали (так же, как выделяется текст), то dygraphs приблизит его. Обратно можно вернуться по двойному щелчку.

Далее рассмотрим, каким образом можно изменять внешний вид графика.


## Отображение нескольких временных рядов

Для того, чтобы отобразить несколько временных рядов, достаточно объединить эти ряды при помощи функции `cbind()`:

```{r Несколько временных рядов}
two_series <- cbind(time_series1, time_series2)

head(two_series, 12)

dygraph(two_series)
```


## Добавление подписей

Чтобы добавить заголовок к самому графику, достаточно в аргументах функции dygraph написать: `main = "Текст заголовка"`.

```{r Подписи заголовка}
dygraph(two_series, main = "Два графика")
```


В этом графике недостает адекватных подписей в легенде. Их можно добавить к графику при помощи оператора `%>%` (**pipe**, или **конвейер**). Вспомним, что эта операция работает слева направо и передает данные слева от оператора в функцию, указанную справа от оператора `%>%`.

Чтобы изменить подписи данных, необходимо добавить к графику, построенному функцией `dygraph()`, дополнительные параметры при помощи `%>%` и `dySeries("название ряда, как в вашем коде", label = "Название, которое будет на графике")`.

```{r Подписи рядов}
dygraph(two_series, main = "Два графика") %>%
  dySeries("time_series1", label = "Первый ряд") %>%
  dySeries("time_series2", label = "Второй ряд")
```

Чтобы изменить подписи осей, нужно добавить параметры функции `dygraph()`: `xlab = "Название оси Х"` и `ylab = "Название оси Y"`, как в следующем коде:

```{r Подписи осей}
dygraph(two_series, 
        main = "Два графика", 
        xlab = "Годы", 
        ylab = "Значение показателя") %>%
  dySeries("time_series1", label = "Первый ряд") %>%
  dySeries("time_series2", label = "Второй ряд")
```

## Дополнительные опции визуализации

При желании, при помощи добавления различных опций можно усовершенствовать внешний вид графика - например, поменять цвета, с которыми отображаются временные ряды. Это можно сделать, добавив функцию `dyOptions()`, как в следующем коде.

```{r Цвета}
dygraph(two_series, 
        main = "Два графика", 
        xlab = "Годы", 
        ylab = "Значение показателя") %>%
  dySeries("time_series1", label = "Первый ряд") %>%
  dySeries("time_series2", label = "Второй ряд") %>%
  dyOptions(colors = RColorBrewer::brewer.pal(3, "Set2"))
```

Параметры, указанные в функции `dyOptions()` влияют на все ряды в графике.
Для того, чтобы менять параметры определенных частей графика, необходимо добавить параметры к функциям, рисующим эти части графика.

Например, чтобы рисовать линию первого ряда толще, нужно добавить в `dySeries()` c `time_series1` параметр `strokeWidth = 2`.
Если этот же параметр указать в `dyOptions()`, толще станут все линии временных рядов.

```{r Параметры ряда}
dygraph(two_series, 
        main = "Два графика", 
        xlab = "Годы", 
        ylab = "Значение показателя") %>%
  dySeries("time_series1", label = "Первый ряд", strokeWidth = 2) %>%
  dySeries("time_series2", label = "Второй ряд")
```

Легенду графика тоже можно настроить. Например, можно сделать так, чтобы она следовала за мышью.

```{r Двигающаяся легенда}
dygraph(two_series, 
        main = "Два графика", 
        xlab = "Годы", 
        ylab = "Значение показателя") %>%
  dySeries("time_series1", label = "Первый ряд", strokeWidth = 2) %>%
  dySeries("time_series2", label = "Второй ряд") %>%
  dyLegend(show = "follow")
```

## Выделение событий на графике

Пакет `dygraphs` позволяет делать комментарии, указывая определенные события на графике.

```{r График с событиями}
dygraph(time_series1, main = "График с событиями") %>%
  dyEvent(dmy("01.01.2009"), "Кризисный 2009 год", labelLoc = "top") %>%
  dyEvent(dmy("01.01.2014"), "2014 год", labelLoc = "bottom") %>%
  dyAnnotation(dmy("01.12.2014"), 
               text = "A", 
               tooltip = "Пиковое значение") #наведите мышь на квадрат с буквой A, чтобы посмотреть текст
```

## Визуализация результатов прогнозирования

В качестве основы для прогнозирования возьмем ряд `time_series1`.

```{r Получение прогноза}
ts_subset <- time_series1 %>% 
  window(start = c(2014, 1)) #возьмем ряд поменьше
hw <- HoltWinters(ts_subset)
p <- predict(hw, n.ahead = 12, prediction.interval = TRUE)

p %>% head() %>% round()
```

```{r Визуализация прогноза}
dygraph(p, "Прогноз") %>%
  dySeries(c("lwr", "fit", "upr")) #сообщаем dySeries, что именно из входных данных нам нужно визуализировать - в данном случае, lwr fit и upr - составные части полученного прогноза.
```

Для сравнения, добавим на график исторические данные. Для этого "склеим" исходный ряд и прогноз:

```{r Визуализация прогноза 2}
# Склеиваем данные
all <- cbind(ts_subset, p)
all %>% tail(14)

# Визуализация
dygraph(all, "Прогноз") %>%
  dySeries("ts_subset", label = "Actual") %>%
  dySeries(c("p.lwr", "p.fit", "p.upr"), label = "Predicted")
```


**Замечание**: при склеивании данных функция `cbind()` добавляет к именам столбцов из второй таблицы префикс с ее именем.


## Выбор интервала наблюдений

Пакет `dygraphs` также имеет удобный инструмент для выбора границ наблюдений.

```{r Выбор границ наблюдений}
dygraph(two_series, 
        main = "График с выбором границ наблюдений", 
        xlab = "Годы", 
        ylab = "Значение показателя") %>%
  dySeries("time_series1", label = "Первый ряд") %>%
  dySeries("time_series2", label = "Второй ряд") %>%
  dyLegend(show = "follow") %>%
  dyRangeSelector() #если передать ему параметр dateWindow = c("1999-01-01", "2002-01-01") то график изначально будет в указанных границах
```


# Ресурсы

В этом документе были рассмотрены несколько простых примеров, полезных при изучении временных рядов в рамках нашего семинара. Другие примеры, а также детальное руководство по использованию пакета можно найти здесь:
https://rstudio.github.io/dygraphs/index.html

