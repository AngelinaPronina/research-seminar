---
title: "Методы экспоненциального сглаживания II"
author: "Заходякин Г.В., postlogist@gmail.com"
output: 
  html_document: 
    number_sections: no
    toc: yes
    toc_depth: 3
---

```{r Настройка, include=TRUE}
options(digits = 3) # Количество значащих цифр при выводе
```

```{r Подключение библиотек, message=FALSE, warning=FALSE}
library(tidyverse) # визуализация и трансформация данных
library(forecast) # анализ временных рядов и прогнозирование
library(fpp2) # Примеры временных рядов
library(sophisthse) # Загрузка временных рядов из базы Sophist
```

# Введение

В этом блокноте рассматриваются новые модели экспоненциального сглаживания с нелинейным трендом и вводится общая классификация моделей экспоненциального сглаживания, доступных в пакете `forecast`. Рассматривается получение доверительных интервалов для прогноза. Материал составлен на основе разделов [7.4-7.7](https://www.otexts.org/fpp2/ch-expsmooth.html) книги Hyndman R., Athanasopoulos G. Forecasting: Principles and practice.

В классическом методе Хольта используются следующие уравнения для выделения компонентов ряда:

 - Уровень: 

$$ L_t = y_t \cdot \alpha + (L_{t-1} + b_{t-1})\cdot (1-\alpha) $$

- Тренд (скорость роста): 

$$ b_t = (L_t - L_{t-1}) \cdot \beta + b_{t-1} \cdot (1-\beta) $$

Для прогнозирования используются последние значения уровня и скорости роста ряда:

$$ \hat{y}_{T+h} = L_{T} + h \cdot b_T $$

Таким образом, при прогнозировании предполагается линейный рост ряда. Однако многие природные и экономические процессы нелинейны. Поэтому были разработаны модификации модели Хольта, допускающие нелинейный тренд (экспоненциальный рост или затухание).

# Моделирование нелинейных трендов
## Модель Хольта с экспоненциальным трендом

Одной из модификаций метода Хольта является использование мультипликативного тренда, при котором скорость роста задается не как постоянная величина, а как заданный процент от достигнутого на предыдущем шаге уровня (коэффициент роста):

$$ \hat{y}_{T+h} = L_{T}  \cdot b_T^h $$

Поскольку теперь абсолютное увеличение прогноза на шаге растет с увеличением достигнутого уровня, как в формуле сложных процентов, - тренд экспоненциально возрастает. Данную модель можно использовать на этапе "взрывного" роста, например при выводе нового продукта или выходе на новый рынок. Пользоваться ей нужно с осторожностью, т.к. фаза неограниченного роста не продолжается бесконечно и с течением времени рост замедляется и затем сменяется спадом.

Модифицированные формулы для компонентов ряда: 

 - Уровень: 

$$ L_t = y_t \cdot \alpha + (L_{t-1} \cdot  b_{t-1})\cdot (1-\alpha) $$

- Тренд (скорость роста): 

$$ b_t = (L_t / L_{t-1}) \cdot \beta + b_{t-1} \cdot (1-\beta) $$


## Пример
В R метод Хольта c экспоненциальным трендом реализован функцией `forecast::holt()` с параметром: `exponential = TRUE`.

Сравним модели Хольта с линейным и экспоненциальным трендом на данных об объеме пассажирских авиаперевозок австралийскими авиакомпаниями (см. `?ausair`)


```{r Модель Хольта экспоненциальным трендом}
air_subset <- window(ausair, start = 1990) # Удаляем совсем старые данные

air_train <- window(air_subset, start = 1990, end = 1999) # Обучающий период


# Модель с линейным трендом
air_lin <- holt(air_train, alpha = 0.6, beta = 0.2, h = 16)

# Модель с экспоненциальным трендом
air_exp <- holt(air_train, alpha = 0.6, beta = 0.2, 
                initial = 'simple',  # отключаем автоподбор начальных значений
                exponential = T, h = 16) 
```

**Примечание:** Параметр `inintial` позволяет задать метод определения начальных значений закономерных компонентов ряда (инициализации). В данном случае выбран простой метод. По умолчанию используется оптимизация, однако в этом случае данный метод вызывает ошибку при построении модели.



Визуальное сравнение моделей

```{r Визуальное сравнение моделей с линейным и экспоненциальным трендом}

autoplot(air_subset, series = 'Факт') +
  autolayer(air_lin$mean, series = 'Линейный тренд') +
  autolayer(air_exp$mean, series = 'Экспоненциальный тренд') +
  labs(title = 'Ежегодный объем пассажирских перевозок австралийскими авиалиниями', 
       x = NULL, y = 'млн чел.', colour = 'Обозначения')

```

Сравнение показателей ошибки моделей с линейным и экспоненциальным трендом, на тестовом периоде:

```{r Ошибка моделей в тестовом периоде }

rbind(accuracy(air_lin, air_subset)['Test set',], 
      accuracy(air_exp, air_subset)['Test set',]) %>%
  as_tibble() %>%
  round(4) %>%
  
  mutate(`Метод` = c('Линейный тренд', 
                     'Экспоненциальный тренд')) %>%
  select(`Метод`, MASE, MAPE, MPE) %>%
  arrange(MASE)

```


На тестовом периоде гипотеза об экспоненциальном росте числа пассажиров не подтвердилась и прогноз получился слишком оптимистичным. Тем не менее, более [свежие данные](http://data.is/x5KiEO) демонстрируют ускорение роста объемов авиаперевозок.


## Модель Хольта с затухающим трендом

Классическая и мультипликативная модели Хольта дают прогнозы, предполагающие неизменный или экспоненциально возрастающий рост в будущем. Данное предположение не всегда справедливо и в любом процессе может наступать период замедления роста и стагнации. Поэтому часто прогнозы по таким моделям оказываются завышенными. Для моделирования таких временных рядов используется модель с **затухающим трендом** (*damped trend*), предложенная Gardner и McKenzie (1985). В этой модели введен еще один параметр: 

$$ 0 < \phi < 1, $$

который с течением времени уменьшает скорость роста. В пределе, тренд становится нулевым, а прогноз - горизонтальным. Модели с затухающим трендом показали хорошие результаты при практическом применении.

Коэффициент затухания тренда может использоваться совместно как с аддитивными, так и с мультипликативными моделями.

### Аддитивная модель с затухающим трендом

Уравнения для выделения компонентов ряда:

 - Уровень: 

$$ L_t = y_t \cdot \alpha + (L_{t-1} + \phi b_{t-1})\cdot (1-\alpha) $$

- Тренд (скорость роста): 

$$ b_t = (L_t - L_{t-1}) \cdot \beta + \phi b_{t-1} \cdot (1-\beta) $$

Уравнение для прогнозирования:

$$ \hat{y}_{T+h} = L_{T} + (\phi + \phi^2 + \dots + \phi^h)  b_T $$

При $\phi  = 1$ модель эквивалентна классической модели Хольта. При $\phi < 1$ тренд с течением времени постепенно затухает и прогноз становится горизонтальным. 


В пакете `forecast` модель с затухающим трендом реализована функцией `holt()` с параметром `damped = TRUE`. По умолчанию, диапазон возможных значений для параметра затухания $\phi$ ограничен интервалом [0.8, 0.98].



### Мультипликативная модель с затухающим трендом

Эта модель была предложена в работе Taylor, 2003.

Уравнения для выделения компонентов ряда:

 - Уровень: 

$$ L_t = y_t \cdot \alpha + L_{t-1}  b_{t-1} ^ \phi \cdot (1-\alpha) $$

- Тренд (скорость роста): 

$$ b_t = (L_t / L_{t-1}) \cdot \beta + b_{t-1}^\phi \cdot (1-\beta) $$

Уравнение для прогнозирования:

$$ \hat{y}_{T+h} = L_{T}   b_T ^ {\phi + \phi^2 + \dots + \phi^h} $$

В пакете `forecast` модель с затухающим мультипликативным трендом реализована функцией `holt()` с параметрами `damped = TRUE, exponential = TRUE`. Эта модель дает менее консервативные прогнозы, чем аддитивная модель с затухающим трендом.


## Пример

Рассмотрим применение моделей с затухающим трендом на примере данных об уровне убийств женщин в США (см. `?wmurders`  и [источник](http://data.is/XKa24F).


```{r Модели с затухающим трендом для уровня убийств}
# Отбор данных
wmurders_subset <- window(wmurders, start = 1987) # сокращенный ряд, включая тестовый период
wmurders_train <- window(wmurders_subset, end = 1999) # обучающий период

# Моделирование
wmurders_lin <- holt(wmurders_train, h = 5) # Линейный тренд
wmurders_exp <- holt(wmurders_train, exponential = T, h = 5) # экспоненциальный тренд
wmurders_ad <- holt(wmurders_train, damped = T, h = 5) # адд. затухающий тренд
wmurders_md <- holt(wmurders_train, exponential = T, damped = T, h = 5) # мульт. затухающий тренд

```


Сравним поведение моделей на тестовом периоде:

```{r Визуальное сравнение моделей с затухающим трендом}

autoplot(wmurders_subset, series = 'Факт') +
  autolayer(wmurders_lin$mean, series = 'Лин. тренд') +
  autolayer(wmurders_exp$mean, series = 'Эксп. тренд') +
  autolayer(wmurders_ad$mean, series = 'Адд. зат. тренд') +
  autolayer(wmurders_md$mean, series = 'Мульт. зат. тренд') +

  labs(title = 'Уровень убийств женщин в США, на 100 000 населения',
       y = NULL, x = NULL, color = NULL)

```

Сравнение показателей ошибки на тестовом периоде:

```{r Ошибка моделей с затухающим трендом в тестовом периоде }


rbind(accuracy(wmurders_lin, wmurders_subset)['Test set',], 
      accuracy(wmurders_exp, wmurders_subset)['Test set',],
      accuracy(wmurders_ad, wmurders_subset)['Test set',],
      accuracy(wmurders_md, wmurders_subset)['Test set',]) %>%

  as_tibble() %>%
  round(4) %>%
  
  mutate(`Метод` = c("Линейный тренд", "Экспоненциальный тренд",  
                     "Адд. затухающий тренд", 
                     "Мульт. затухающий тренд")) %>%
  select(`Метод`, MASE, MAPE, MPE) %>%
  arrange(MASE)


```

В данном примере наиболее близким к действительности оказался прогноз, полученный по модели с аддитивным затухающим трендом.


## Модификации модели Винтерса с экспоненциальным и затухающим трендом 

Возможность использования экспоненциального и затухающего тренда реализована также и в функции `hw()`.
Формулы для модифицированной модели Винтерса приведены в разделе [7.3](https://www.otexts.org/fpp2/sec-7-Taxonomy.html) книги Forecasting: Principles and Practice.

Сравним эффективность различных моделей на ряде ежеквартального количества визитов японцев в Австралию (`?arrivals`).

```{r Визуализация ряда по количеству визитов}
j_arrivals <- arrivals[, 'Japan'] 
autoplot(j_arrivals) + 
  labs(title = 'Ежеквартальное количество визитов японцев в Австралию', 
       x = NULL, y = 'тыс.')
```

Начиная с 1996 года наблюдается спад в количестве визитов. Используем данные с 1996 по 2009 годы в качестве обучающего периода, а данные с 2010 по 2012 годы - в качестве тестового.

```{r Отбор данных} 
j_arrivals_subset <- window(j_arrivals, start = 1996)
j_arrivals_train <- window(j_arrivals_subset, end = 2009)

# Мультипликативная модель Винтерса
j_arrivals_w <- hw(j_arrivals_train, seasonal = 'multiplicative', h = 14)

# Мультипликативная модель Винтерса с мультипликативным трендом
j_arrivals_mt <- hw(j_arrivals_train, seasonal = 'multiplicative', 
              exponential = T, h = 14)

# Мультипликативная модель Винтерса с затухающим трендом
j_arrivals_dt <- hw(j_arrivals_train, seasonal = 'multiplicative',
                    damped = T, h = 14)

# Мультипликативная модель Винтерса с затухающим мультипликативным трендом
j_arrivals_mdt <- hw(j_arrivals_train, seasonal = 'multiplicative', 
                     exponential = T, damped = T, h = 14)

```


Визуальное сравнение прогнозов с фактом.

```{r Визуальное сравнение прогнозов по различным модификациям модели Винтерса}

autoplot(j_arrivals_subset, series = 'Факт') +
  autolayer(j_arrivals_w$mean, series = 'Винтерс') +
  autolayer(j_arrivals_mt$mean, series = 'Мульт. тренд') +
  autolayer(j_arrivals_dt$mean, series = 'Зат. тренд') +
  autolayer(j_arrivals_mdt$mean, series = 'Зат. мульт. тренд') +

  labs(title = 'Ежеквартальное количество визитов японцев в Австралию',
       y = 'тыс.', x = NULL, color = NULL)

```


Сравнение показателей ошибки на тестовом периоде:


```{r Ошибка моделей Винтерса с затухающим трендом в тестовом периоде }


rbind(accuracy(j_arrivals_w, j_arrivals_subset)['Test set',], 
      accuracy(j_arrivals_mt, j_arrivals_subset)['Test set',],
      accuracy(j_arrivals_dt, j_arrivals_subset)['Test set',],
      accuracy(j_arrivals_mdt, j_arrivals_subset)['Test set',]) %>%

  as_tibble() %>%
  round(4) %>%
  
  mutate(`Метод` = c("Винтерс", "Мульт. тренд", "Зат. тренд", 
                     "Зат. мульт. тренд")) %>%
  select(`Метод`, MASE, MAPE, MPE) %>%
  arrange(MASE)


```


На долгосрочном горизонте тренд к снижению количества визитов становится менее выраженным, поэтому в данном случае оказалась более адекватной фактическим данным модель с затухающим мультипликативным трендом.


# Классификация моделей экспоненциального сглаживания

Модель экспоненциального сглаживания можно компактно описать, указав наличие и тип закономерных компонентов ряда, которые в ней учитываются. Впервые подобная классификация была предложена Pegels (1969). По мере развития моделей, она несколько раз дорабатывалась. В книге Hyndman предложено использование следующих обозначений: 

- N - компонент отсутствует
- A - аддитивная модель
- M - мультипликативная модель
- Ad - аддитивная модель тренда с затуханием
- Md - мультипликативная модель тренда с затуханием

Всего возможно 3 вида сезонности - N, A и M и 5 видов тренда (см. выше), поэтому в данной классификации присутствует 15 различных моделей.

![Классификация моделей](pics/taxonomy_letters.jpeg)

Согласно данной системе обозначений, модель Хольта можно задать как (A, N), а мультипликативную модель Винтерса с линейным трендом - как (A, M).

Визуально представить области применения моделей помогает графический вариант классификации, предложенный Gardner.

![Визуальная классификация](pics/taxonomy_es.jpeg)

# Модели пространства состояний

Ограничением моделей экспоненциального сглаживания является то, что они не позволяют получать интервальный прогноз, т.к. в модели не учитываются свойства распределения ошибок модели. Эта проблема решена в современном расширении моделей этого типа - моделей пространства состояний (state space models). Здесь мы рассмотрим только самую простую из них, с другими типами моделей можно познакомиться в разделе [7.5](https://www.otexts.org/fpp2/sec-7-ETS.html) книги Forecasting: Principles and Practice.

Модели пространства состояний включают не только уравнения для получения компонентов ряда (**state equations**), но и уравнения, связывающие наблюдаемые значения с прогнозом по модели (**observation equations**).

На примере простого экспоненциального сглаживания:

Уравнение для состояния (компонента ряда):

$$ L_t = L_{t-1} + \alpha \varepsilon_t $$
Это уравнение - такое же по структуре, как и уравнение для простого экспоненциального сглаживания, однако здесь $\varepsilon$ - случайная ошибка, имеющая нормальное распределение: 

$$\varepsilon \sim NID(0, \sigma^2)$$

Уравнение для наблюдения:

$$ y_t = L_{t-1} + \varepsilon_t $$

Поскольку теперь в модели присутствует в явном виде ошибка прогноза, можно получить распределение возможных прогнозов и вычислить границы доверительного интервала для прогноза. Таким образом, модели пространства состояний позволяют получать интервальный прогноз.

Ошибка может включаться в модели пространства состояний аддитивным или мультипликативным способом, поэтому общее количество моделей этого типа - 30. Точечные прогнозы по этим моделям получаются одинаковые, но доверительные интервалы будут отличаться.

В R модели пространства состояний реализованы с помощью функции `forecast::ets()`. Основными параметрами функции являются исходные данные, а также спецификация модели (`model = ???`), которая  определяется типом ошибки (A или M) и закономерных компонентов (N, A, M или Z = автовыбор) ряда. Поддерживаются модели с затухающим трендом. Другие параметры можно посмотреть в справке: `?ets`.

Функция `ets()` строит модель прогнозирования. Для применения полученной модели необходимо использовать функцию `forecast()`.

Если не указывать никаких параметров, то производится автовыбор лучшей модели на основе ошибки обучающего периода. По умолчанию используется критерий AIC (Akaike Information Criteria):

$$ AIC = - 2 \log L + 2k $$

Критерий состоит из двух слагаемых, первое из которых - логарифм правдоподобия (т.е. вероятности получить наблюдаемые данные при использовании модели с заданными параметрами), который тем меньше, чем точнее модель (т.е. чем меньше ошибка на обучающем периоде). Второе слагаемое - штраф за сложность модели, $k$ - это число оцениваемых по данным параметров модели (константы сглаживания, коэффициент затухания, начальные значения состояний). Чем меньше значение AIC, тем лучше модель.

Реализованы и другие критерии, отличающиеся большей величиной штрафа за сложность.

## Пример

Рассмотрим использование функции `ets()` на примере оборота розничной торговли.


```{r Модель пространства состояний для оборота розничной торговли}

# Подготовка данных
retail <- 
  sophisthse('RTRD_M') %>%
  .[, 'RTRD_M'] %>% 
  window(start = 2005)

retail_train <- window(retail, end = 2016)
retail_title <- 'Оборот розничной торговли России'
retail_units <- 'млрд руб'

# Построение модели
retail_auto <- ets(retail_train)

# Горизонт прогноза
h <- length(retail) - length(retail_train)

# Прогнозирование
retail_auto_fc <- forecast(retail_auto, h = h)

# Сравнение факта и прогноза
autoplot(retail, series = 'Факт') +
  autolayer(retail_auto_fc$mean, series  = 'Прогноз')  +
  labs(title = retail_title, 
       y = retail_units, x = NULL, color = NULL)

```

**Замечание:** В отличие от прогнозов, полученных по классическим моделям (наивным, экспоненциального сглаживания, Хольта и Винтерса), функция `ets()` создает только модель, но не прогноз по ней. Поэтому для получения прогноза требуется рассчитать его при помощи функции `forecast()` и модели, полученной на первом шаге, через `ets()`.

Исследуем сводку по модели:

```{r}
summary(retail_auto)
```

Получена модель с мультипликативной сезонностью, аддитивным затухающим трендом и мультипликативной ошибкой. Коэффициент затухания вблизи своего максимального значения (тренд близок к линейному).

На тестовом периоде модель дала немного заниженный прогноз, т.к. в ней использовался затухающий тренд. Попробуем построить модель Винтерса с мультипликативным затухающим трендом. Тип сезонности и ошибки будет определен автоматически.

```{r Задание спецификации модели вручную}

# Построение модели
retail_md <- ets(retail_train, model = 'ZMZ', damped = TRUE)
summary(retail_md)
# Прогнозирование
retail_md_fc <- forecast(retail_md, h = h)

```


Сравним результат с фактом:
```{r Сравнение модели с вручную заданной спецификацией и факта}
# Сравнение факта и прогноза
autoplot(retail, series = 'Факт') +
  autolayer(retail_md_fc$mean, series  = 'Прогноз')  +
  labs(title = retail_title, 
       y = retail_units, x = NULL)

```


Сравним ошибки моделей в тестовом периоде количественно:

```{r Сравнение ошибок моделей ETS}


rbind(accuracy(retail_auto_fc, retail)['Test set',], 
      accuracy(retail_md_fc, retail)['Test set',]) %>%
  
  as_tibble() %>%
  round(4) %>%
  
  mutate(`Метод` = c('Адд. зат. тренд (авто)', 
                     'Мульт. зат. тренд (настройка)')) %>%
  select(`Метод`, MASE, MAPE, MPE) %>%
  arrange(MASE)


```
